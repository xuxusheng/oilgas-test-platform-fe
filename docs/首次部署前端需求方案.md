# 首次部署前端需求方案

## 一、需求概述

当系统首次部署时，数据库中没有任何用户数据。前端需要提供相应的界面和流程来引导用户创建第一个管理员账户。

## 二、核心功能需求

### 2.1 应用启动流程检测

**需求描述**: 应用初始化时，必须先检测系统状态，决定用户的访问路径。

**处理逻辑**:

1. 应用启动/刷新时，调用 `GET /api/auth/system-status`
2. 根据响应决定后续流程：
   - 如果 `firstDeployment = true` → 跳转到初始化页面
   - 如果 `firstDeployment = false` → 检查本地 token，跳转到登录或仪表板

**建议实现位置**:

- 路由守卫 (Router Guard)
- 或应用入口组件 (App.vue/main.js)

### 2.2 首次部署初始化页面

**需求描述**: 当检测到系统首次部署时，显示专门的管理员创建页面。

**页面功能**:

- 显示系统首次部署提示信息
- 表单包含以下字段：
  - 用户名（固定显示为 "admin"，不可编辑，带提示说明）
  - 密码输入框（6-30位）
  - 确认密码输入框
- 提交按钮
- 错误/成功提示区域

**表单验证**:

- 密码不能为空
- 密码长度 6-30 位
- 确认密码必须与密码一致
- 提交前进行前端验证

**提交处理**:

1. 调用 `POST /api/auth/init-admin`
2. 成功后：
   - 显示成功提示
   - 3秒后自动跳转到登录页
   - 或提供"立即登录"按钮
3. 失败后：
   - 显示错误信息
   - 保持表单状态，允许重试

**UI 建议**:

- 清晰的标题："系统首次部署"
- 副标题："请创建第一个管理员账户"
- 警告提示："用户名固定为 admin，创建后无法修改"
- 密码强度提示（可选）

### 2.3 登录页面调整

**需求描述**: 登录页面需要根据系统状态调整显示内容。

**功能调整**:

- 在登录页面加载时，可选调用 `/api/auth/system-status` 检测状态
- 如果系统首次部署：
  - 可以隐藏"注册"按钮
  - 或显示提示："系统首次部署，请联系管理员创建账户"
- 如果系统已初始化：
  - 正常显示登录和注册选项

### 2.4 注册功能控制（可选）

**需求描述**: 根据业务需求，可能需要控制注册功能的开放时机。

**两种策略**:

**策略 A - 完全开放**（当前设计）:

- 首次部署后，任何人都可以注册
- 注册用户默认为 MEMBER 角色

**策略 B - 管理员控制**（可选）:

- 首次部署后，注册功能对普通用户不可见
- 仅管理员可以在后台创建用户
- 需要修改前端注册按钮的显示逻辑

## 三、用户流程图

```
应用启动
    ↓
调用 /api/auth/system-status
    ↓
┌──────────────┴──────────────┐
│                              │
firstDeployment=true      firstDeployment=false
│                              │
↓                              ↓
显示初始化页面              检查本地 token
│                              │
用户输入密码                  ┌───┴───┐
│                      有token   无token
提交 /api/auth/init-admin      │         │
│                      ↓         ↓
创建成功                    调用 /me    显示登录页
│                      │         │
↓                      ↓         ↓
显示成功提示              跳转仪表板    用户登录
↓                              │
3秒后跳转登录页                └──────────┘
或显示"立即登录"按钮
```

## 四、异常处理需求

### 4.1 网络错误

- 系统状态检测失败 → 显示网络错误提示，提供重试按钮
- 创建管理员失败 → 显示具体错误信息

### 4.2 业务错误

- 密码不匹配 → 前端实时验证，提交时再次验证
- 密码长度不足 → 前端验证 + 后端错误提示
- 系统已初始化 → 提示"系统已存在管理员，请直接登录"
- 用户名已存在 → 提示"用户名已存在"（理论上不会发生）

### 4.3 并发情况

- 多个浏览器同时访问首次部署页面
- 第一个用户创建成功后，其他页面应自动失效

## 五、UI/UX 要求

### 5.1 初始化页面设计建议

**布局**:

```
┌─────────────────────────────┐
│                             │
│   🏢 系统首次部署            │
│                             │
│   请创建第一个管理员账户      │
│                             │
│   用户名                     │
│   [admin] (不可编辑)         │
│   💡 用户名固定为 admin      │
│                             │
│   密码                       │
│   [●●●●●●]                   │
│   6-30位字符                 │
│                             │
│   确认密码                   │
│   [●●●●●●]                   │
│                             │
│   [ 创建管理员 ]             │
│                             │
│   ❌ 错误提示区域            │
│   ✅ 成功提示区域            │
│                             │
└─────────────────────────────┘
```

### 5.2 状态提示

**加载状态**:

- 检测系统状态时：显示加载动画
- 提交创建时：按钮禁用，显示"创建中..."

**成功状态**:

- 绿色提示框
- 显示管理员信息（用户名、角色）
- 倒计时跳转提示

**错误状态**:

- 红色错误框
- 显示具体错误原因
- 保留表单数据，允许重试

### 5.3 响应式设计

- 移动端适配
- 表单元素大小适中
- 键盘友好（移动端自动弹出数字键盘用于密码输入）

## 六、状态管理需求

### 6.1 全局状态（可选）

建议在状态管理器中存储：

- `systemStatus`: { firstDeployment, userCount, message }
- `isAdminCreated`: boolean

### 6.2 本地存储

- 登录成功后的 token 存储
- 用户信息缓存

## 七、路由配置需求

### 7.1 新增路由

```javascript
{
  path: '/init-admin',
  name: 'InitAdmin',
  component: () => import('@/views/auth/InitAdmin.vue'),
  meta: { requiresAuth: false, title: '系统初始化' }
}
```

### 7.2 路由守卫逻辑

```javascript
// 伪代码
router.beforeEach(async (to, from, next) => {
  // 1. 如果是初始化页面，直接放行
  if (to.path === '/init-admin') {
    return next()
  }

  // 2. 需要认证的页面
  if (to.meta.requiresAuth) {
    const token = localStorage.getItem('token')
    if (!token) {
      // 检测系统状态
      const status = await checkSystemStatus()
      if (status.firstDeployment) {
        return next('/init-admin')
      } else {
        return next('/login')
      }
    }
  }

  // 3. 其他情况正常放行
  next()
})
```

## 八、API 调用规范

### 8.1 检测系统状态

```javascript
GET /api/auth/system-status

// 响应
{
  "code": 200,
  "data": {
    "firstDeployment": true,
    "userCount": 0,
    "message": "系统首次部署，请创建第一个管理员账户"
  }
}
```

### 8.2 创建第一个管理员

```javascript
POST /api/auth/init-admin
Content-Type: application/json

// 请求
{
  "password": "SecurePass123",
  "confirmPassword": "SecurePass123"
}

// 成功响应
{
  "code": 200,
  "data": {
    "id": 1,
    "username": "admin",
    "role": "ADMIN"
  }
}

// 失败响应
{
  "code": 400,
  "message": "系统已存在用户，无法重复创建第一个管理员"
}
```

## 九、测试用例

### 9.1 正常流程测试

- ✅ 首次部署：检测 → 初始化 → 创建 → 登录 → 进入系统
- ✅ 非首次部署：检测 → 登录 → 进入系统

### 9.2 异常流程测试

- ✅ 密码不匹配提示
- ✅ 密码长度不足提示
- ✅ 空密码提交阻止
- ✅ 网络错误处理
- ✅ 重复创建拦截

### 9.3 边界情况测试

- ✅ 刷新初始化页面
- ✅ 多标签页同时访问
- ✅ 创建成功后返回初始化页面
- ✅ 浏览器关闭后重新访问

## 十、性能优化建议

### 10.1 缓存策略

- 系统状态检测结果可缓存 5-10 秒
- 避免频繁调用接口

### 10.2 加载优化

- 初始化页面组件懒加载
- 表单组件按需引入

### 10.3 错误重试

- 网络错误提供自动重试机制
- 重试间隔建议 2-3 秒

## 十一、兼容性要求

### 11.1 浏览器支持

- Chrome/Edge 最新版
- Firefox 最新版
- Safari 最新版
- 移动端浏览器

### 11.2 版本兼容

- 支持 IE11+（如需要）
- 降级方案：提示用户升级浏览器

## 十二、可选增强功能

### 12.1 密码强度提示

- 实时显示密码强度（弱/中/强）
- 建议包含大小写、数字、特殊字符

### 12.2 可视化反馈

- 密码可见性切换（显示/隐藏）
- 创建成功后的动画效果

### 12.3 多语言支持

- 支持中英文切换
- 错误提示国际化

### 12.4 暗黑模式

- 适配系统的暗黑主题

## 十三、与后端的配合

### 13.1 错误码处理

- `400`: 业务错误（密码不匹配、已存在用户等）
- `401`: 认证错误（不会出现，因为无需认证）
- `500`: 服务器错误

### 13.2 响应时间

- 系统状态检测：预期 < 500ms
- 创建管理员：预期 < 2000ms

### 13.3 并发控制

- 创建按钮点击后禁用，防止重复提交
- 成功/失败后才恢复按钮状态

## 十四、上线检查清单

- [ ] 初始化页面 UI 设计完成
- [ ] 路由守卫逻辑实现
- [ ] API 接口调用集成
- [ ] 表单验证功能
- [ ] 错误处理机制
- [ ] 成功流程测试
- [ ] 异常流程测试
- [ ] 移动端适配
- [ ] 浏览器兼容性测试
- [ ] 性能测试
- [ ] 文档更新

## 十五、参考资料

### 后端文档

- 完整技术设计：`docs/首次部署用户创建方案.md`
- API 使用说明：`docs/首次部署API使用说明.md`
- 实现总结：`docs/首次部署实现总结.md`

### 后端接口

- `GET /api/auth/system-status` - 检测系统状态
- `POST /api/auth/init-admin` - 创建第一个管理员

---

**说明**: 本文档仅描述需求和业务逻辑，不包含具体代码实现。前端开发人员可根据技术栈（Vue/React/Angular等）选择合适的实现方式。

**版本**: v1.0
**最后更新**: 2025-12-25
